{% extends "base.html" %}
{% load static %}

{% block title %}SOQL查询 - Django Workbench{% endblock %}

{% block extra_css %}
<!-- Salesforce Lightning Design System CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/design-system/2.22.1/styles/salesforce-lightning-design-system.min.css">
<style>
    /* ===== Phoenix Inbox 风格布局 ===== */

    /* 深色顶部导航栏覆盖 */
    .modern-navbar {
        background: #1F2937 !important;
        border-bottom: 1px solid #374151 !important;
    }

    .modern-navbar-brand {
        color: #F9FAFB !important;
    }

    .modern-navbar-brand:hover {
        color: #60A5FA !important;
    }

    .modern-navbar-brand i {
        color: #60A5FA !important;
    }

    .modern-nav-link {
        color: #D1D5DB !important;
    }

    .modern-nav-link:hover {
        background-color: #374151 !important;
        color: #F9FAFB !important;
    }

    .modern-nav-item.active .modern-nav-link {
        background-color: #374151 !important;
        color: #F9FAFB !important;
    }

    /* 连接信息栏 - 匹配深色主题 */
    .connection-bar {
        background: #111827 !important;
        border-bottom: 1px solid #374151 !important;
        color: #D1D5DB !important;
    }

    .connection-bar strong {
        color: #F9FAFB !important;
    }

    .connection-bar i {
        color: #60A5FA !important;
    }

    /* 全局样式 */
    body {
        background-color: #F9FAFB;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        overflow-y: auto;
        overflow-x: hidden;
        color: #111827;
        margin: 0;
        padding: 0;
    }

    /* 主容器布局 */
    .query-page-container {
        display: flex;
        min-height: calc(100vh - 60px);
        background-color: #F9FAFB;
    }

    /* 侧边栏 - Phoenix Inbox 风格 */
    .query-sidebar {
        width: 260px;
        background: #FFFFFF;
        border-right: 1px solid #E5E7EB;
        height: calc(100vh - 60px);
        position: sticky;
        top: 60px;
        overflow-y: auto;
        flex-shrink: 0;
        padding: 1.5rem 1rem;
    }

    .query-sidebar-header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #F3F4F6;
    }

    .query-sidebar-title {
        font-size: 0.75rem;
        font-weight: 700;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.075em;
        margin-bottom: 0;
        padding: 0 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sidebar-section {
        margin-bottom: 2rem;
    }

    .sidebar-section-title {
        font-size: 0.6875rem;
        font-weight: 700;
        color: #9CA3AF;
        text-transform: uppercase;
        letter-spacing: 0.075em;
        margin-bottom: 0.875rem;
        padding: 0 0.5rem;
    }

    .sidebar-query-item {
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 0.375rem;
        background: transparent;
        cursor: pointer;
        transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        display: block;
        border: 1px solid transparent;
    }

    .sidebar-query-item:hover {
        background: #F9FAFB;
        border-color: #E5E7EB;
        transform: translateX(2px);
    }

    .sidebar-query-item:active {
        transform: translateX(0);
    }

    .sidebar-query-time {
        font-size: 0.6875rem;
        color: #9CA3AF;
        margin-bottom: 0.375rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        font-weight: 600;
    }

    .sidebar-query-text {
        font-size: 0.8125rem;
        color: #374151;
        font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        line-height: 1.5;
        font-weight: 500;
    }

    /* 主内容区域 */
    .query-main-content {
        flex: 1;
        background: #F9FAFB;
        min-height: calc(100vh - 60px);
        overflow-y: auto;
    }

    .query-content-header {
        padding: 2rem 2rem 1.5rem;
        background: #F9FAFB;
        position: sticky;
        top: 0;
        z-index: 10;
        border-bottom: 1px solid #E5E7EB;
    }

    .query-content-header h1 {
        font-size: 1.875rem;
        font-weight: 700;
        color: #111827;
        margin: 0;
        letter-spacing: -0.02em;
    }

    .query-content-body {
        padding: 0 2rem 2rem;
    }

    /* 简洁的卡片样式 - 去除浮雕效果 */
    .query-card {
        background: #FFFFFF;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .query-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #E5E7EB;
        background: #FFFFFF;
    }

    .query-card-title {
        font-size: 1rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.625rem;
        letter-spacing: -0.01em;
    }

    .query-card-title i {
        font-size: 1.125rem;
    }

    .query-card-body {
        padding: 1.5rem;
        background: #FFFFFF;
    }

    /* 查询构建器 */
    .query-builder-section {
        margin-bottom: 1.5rem;
    }

    .field-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        padding: 0.75rem;
        background: #FFFFFF;
    }

    .field-item {
        padding: 0.625rem 0.75rem;
        cursor: pointer;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 0.625rem;
        border: 1px solid transparent;
        margin-bottom: 0.25rem;
    }

    .field-item:hover {
        background: #EFF6FF;
        border-color: #BFDBFE;
        transform: translateX(2px);
    }

    .field-item:active {
        transform: translateX(0);
    }

    .field-checkbox {
        margin: 0;
        accent-color: #3B82F6;
        width: 16px;
        height: 16px;
        cursor: pointer;
        border-radius: 4px;
    }

    .field-type {
        color: #9CA3AF;
        font-size: 0.75rem;
        margin-left: 0.25rem;
        font-weight: 500;
        background: #F3F4F6;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
    }

    /* 表单元素 */
    .slds-scope .slds-form-element__label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        letter-spacing: -0.01em;
    }

    /* Phoenix 风格自定义 Select 下拉菜单 */
    .custom-select-wrapper {
        position: relative;
        width: 100%;
        display: block;
    }

    /* 完全隐藏原生 select */
    .custom-select-wrapper .slds-select {
        position: absolute !important;
        opacity: 0 !important;
        pointer-events: none !important;
        z-index: -1 !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
    }

    /* 自定义 select 触发按钮 - 精确匹配按钮高度 */
    .custom-select-trigger {
        background: #FFFFFF !important;
        border: 1px solid #D1D5DB !important;
        border-radius: 6px !important;
        color: #1F2937 !important;
        font-size: 0.875rem !important;
        font-weight: 400 !important;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
        padding: 0.5rem 2.5rem 0.5rem 1rem !important;
        min-height: 38px !important;
        height: 38px !important;
        line-height: 1.5 !important;
        transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1) !important;
        cursor: pointer !important;
        width: 100%;
        text-align: left;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: flex-start !important;
        user-select: none;
        position: relative;
        box-sizing: border-box !important;
        vertical-align: middle;
        letter-spacing: 0.01em !important;
    }

    .custom-select-trigger:hover {
        border-color: #9CA3AF;
        background-color: #FFFFFF;
    }

    .custom-select-trigger.active {
        border-color: #3B82F6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .custom-select-trigger-text {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #6B7280;
    }

    .custom-select-trigger-text.has-value {
        color: #1F2937;
    }

    /* 下拉箭头 */
    .custom-select-arrow {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        transition: transform 0.2s ease;
        pointer-events: none;
    }

    .custom-select-arrow svg {
        width: 100%;
        height: 100%;
        fill: #9CA3AF;
    }

    .custom-select-trigger.active .custom-select-arrow {
        transform: translateY(-50%) rotate(180deg);
    }

    /* 下拉菜单容器 */
    .custom-select-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: #FFFFFF;
        border: 1px solid #D1D5DB;
        border-radius: 6px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        max-height: 320px;
        overflow-y: auto;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }

    .custom-select-dropdown.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    /* 下拉菜单滚动条 */
    .custom-select-dropdown::-webkit-scrollbar {
        width: 8px;
    }

    .custom-select-dropdown::-webkit-scrollbar-track {
        background: #F9FAFB;
        border-radius: 4px;
    }

    .custom-select-dropdown::-webkit-scrollbar-thumb {
        background: #D1D5DB;
        border-radius: 4px;
    }

    .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
        background: #9CA3AF;
    }

    /* Optgroup 标题 */
    .custom-select-optgroup-label {
        padding: 0.625rem 0.875rem 0.375rem;
        font-size: 0.6875rem;
        font-weight: 700;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: #F9FAFB;
        border-top: 1px solid #E5E7EB;
    }

    .custom-select-optgroup-label:first-child {
        border-top: none;
    }

    /* Option 选项 */
    .custom-select-option {
        padding: 0.625rem 0.875rem;
        font-size: 0.875rem;
        color: #374151;
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .custom-select-option:hover {
        background: #F3F4F6;
        color: #1F2937;
    }

    .custom-select-option.selected {
        background: #EFF6FF;
        color: #3B82F6;
        font-weight: 500;
    }

    .custom-select-option.selected::before {
        content: '✓';
        font-weight: 700;
        color: #3B82F6;
        margin-right: 0.25rem;
    }

    /* 空状态占位符 */
    .custom-select-option.placeholder {
        color: #9CA3AF;
        font-style: italic;
        cursor: default;
    }

    .custom-select-option.placeholder:hover {
        background: transparent;
    }

    /* Select 容器优化 */
    .slds-select_container {
        position: relative;
        width: 100%;
        display: block;
    }

    /* 确保容器内的原生 select 完全隐藏 */
    .custom-select-wrapper + * {
        display: none;
    }

    /* 移除 SLDS select 容器的默认样式 */
    .slds-select_container::after {
        display: none !important;
    }

    .slds-select_container .custom-select-wrapper {
        width: 100%;
    }

    /* Input 和 Textarea 样式 */
    .slds-scope .slds-input,
    .slds-scope .slds-textarea {
        background: #FFFFFF;
        border: 1px solid #D1D5DB;
        border-radius: 6px;
        color: #374151;
        font-size: 0.9375rem;
        font-weight: 400;
        padding: 0.5625rem 0.875rem;
        transition: all 0.15s ease-in-out;
    }

    .slds-scope .slds-input:hover,
    .slds-scope .slds-textarea:hover {
        border-color: #9CA3AF;
    }

    .slds-scope .slds-input:focus,
    .slds-scope .slds-textarea:focus {
        border-color: #3B82F6;
        background: #FFFFFF;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        outline: 0;
    }

    /* ===== Phoenix 精致按钮样式 ===== */
    .slds-button {
        border-radius: 6px !important;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
        font-weight: 500 !important;
        font-size: 0.875rem !important;
        padding: 0.5rem 1rem !important;
        transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1) !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 0.5rem !important;
        border: 1px solid transparent !important;
        cursor: pointer !important;
        letter-spacing: 0.01em !important;
    }

    .slds-button:active {
        transform: translateY(0) !important;
    }

    /* Primary 按钮 - 蓝色主色调 */
    .slds-scope .slds-button_brand {
        background: #3B82F6 !important;
        border: 1px solid #3B82F6 !important;
        color: white !important;
        font-weight: 600 !important;
    }

    .slds-scope .slds-button_brand:hover {
        background: #2563EB !important;
        border-color: #2563EB !important;
    }

    .slds-scope .slds-button_brand:active {
        background: #1D4ED8 !important;
        border-color: #1D4ED8 !important;
    }

    /* Outline Primary 按钮 - 边框样式 */
    .slds-scope .slds-button_outline-brand {
        background-color: white !important;
        border: 1px solid #3B82F6 !important;
        color: #3B82F6 !important;
        font-weight: 600 !important;
        min-height: 38px !important;
    }

    .slds-scope .slds-button_outline-brand:hover {
        background-color: #3B82F6 !important;
        border-color: #3B82F6 !important;
        color: white !important;
    }

    .slds-scope .slds-button_outline-brand:active {
        background-color: #2563EB !important;
        border-color: #2563EB !important;
    }

    /* Outline Danger 按钮 - 红色边框样式 */
    .slds-scope .slds-button_outline-danger {
        background-color: white !important;
        border: 1px solid #EF4444 !important;
        color: #EF4444 !important;
        font-weight: 600 !important;
        min-height: 38px !important;
    }

    .slds-scope .slds-button_outline-danger:hover {
        background-color: #EF4444 !important;
        border-color: #EF4444 !important;
        color: white !important;
    }

    .slds-scope .slds-button_outline-danger:active {
        background-color: #DC2626 !important;
        border-color: #DC2626 !important;
    }

    /* Neutral 按钮 - 中性灰色 */
    .slds-scope .slds-button_neutral {
        background: #FFFFFF !important;
        border: 1px solid #E5E7EB !important;
        color: #374151 !important;
        font-weight: 500 !important;
    }

    .slds-scope .slds-button_neutral:hover {
        background: #F9FAFB !important;
        border-color: #D1D5DB !important;
        color: #1F2937 !important;
    }

    .slds-scope .slds-button_neutral:active {
        background: #F3F4F6 !important;
    }

    /* Success 按钮 - 绿色 */
    .slds-scope .slds-button_success {
        background: #10B981 !important;
        border: 1px solid #10B981 !important;
        color: white !important;
        font-weight: 600 !important;
    }

    .slds-scope .slds-button_success:hover {
        background: #059669 !important;
        border-color: #059669 !important;
    }

    .slds-scope .slds-button_success:active {
        background: #047857 !important;
        border-color: #047857 !important;
    }

    /* Danger/Destructive 按钮 - 红色 */
    .slds-scope .slds-button_destructive {
        background: #EF4444 !important;
        border: 1px solid #EF4444 !important;
        color: white !important;
        font-weight: 600 !important;
    }

    .slds-scope .slds-button_destructive:hover {
        background: #DC2626 !important;
        border-color: #DC2626 !important;
    }

    .slds-scope .slds-button_destructive:active {
        background: #B91C1C !important;
        border-color: #B91C1C !important;
    }

    /* Small 按钮尺寸 */
    .slds-scope .slds-button_small {
        padding: 0.375rem 0.875rem !important;
        font-size: 0.8125rem !important;
        min-height: 32px !important;
    }

    /* 禁用状态 */
    .slds-button:disabled,
    .slds-button[disabled] {
        opacity: 0.5 !important;
        cursor: not-allowed !important;
        transform: none !important;
        box-shadow: none !important;
    }

    .slds-button:disabled:hover,
    .slds-button[disabled]:hover {
        transform: none !important;
        box-shadow: none !important;
    }

    /* 按钮组 */
    .slds-button-group {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .slds-button-group-row {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    /* 操作符按钮 */
    .operator-btn {
        min-width: 70px !important;
        padding: 0.5rem 0.75rem !important;
    }

    /* 表格样式 */
    .slds-table {
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 8px;
        overflow: hidden;
    }

    .slds-table thead th {
        background: #F9FAFB;
        color: #374151;
        font-weight: 700;
        font-size: 0.6875rem;
        text-transform: uppercase;
        letter-spacing: 0.075em;
        border-bottom: 1px solid #E5E7EB;
        padding: 1rem 0.75rem;
        white-space: nowrap;
    }

    .slds-table tbody td {
        color: #111827;
        font-size: 0.875rem;
        padding: 1rem 0.75rem;
        border-bottom: 1px solid #F3F4F6;
        transition: background-color 0.15s ease;
    }

    .slds-table tbody tr {
        transition: all 0.15s ease;
    }

    .slds-table tbody tr:hover {
        background: #F9FAFB;
    }

    /* 徽章样式 */
    .slds-scope .slds-badge {
        border-radius: 12px;
        font-weight: 600;
        padding: 0.375rem 0.875rem;
        font-size: 0.75rem;
        letter-spacing: 0.025em;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        border: 1px solid transparent;
    }

    .slds-scope .slds-badge_success {
        background: #D1FAE5;
        color: #065F46;
        border-color: #A7F3D0;
    }

    .slds-scope .slds-badge_warning {
        background: #FEF3C7;
        color: #92400E;
        border-color: #FDE68A;
    }

    /* 查询结果 */
    .query-results {
        max-height: 600px;
        overflow: auto;
        background-color: white;
    }

    /* 隐藏元素 */
    .hidden {
        display: none !important;
    }

    /* 简洁的滚动条样式 */
    *::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    *::-webkit-scrollbar-track {
        background: #F9FAFB;
        border-radius: 5px;
    }

    *::-webkit-scrollbar-thumb {
        background: #D1D5DB;
        border-radius: 5px;
        border: 2px solid #F9FAFB;
        transition: all 0.15s ease;
    }

    *::-webkit-scrollbar-thumb:hover {
        background: #9CA3AF;
    }

    *::-webkit-scrollbar-thumb:active {
        background: #6B7280;
    }

    /* 主内容区域的滚动条 */
    .query-main-content::-webkit-scrollbar-track {
        background: #F9FAFB;
    }

    .query-sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .query-sidebar::-webkit-scrollbar-thumb {
        background: #E5E7EB;
        border: none;
    }

    .query-sidebar::-webkit-scrollbar-thumb:hover {
        background: #D1D5DB;
    }

    /* 加载动画 */
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .fa-spinner {
        animation: spin 1s linear infinite;
    }

    /* 淡入动画 */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .query-card {
        animation: fadeIn 0.3s ease-out;
    }

    /* 链接样式 */
    a {
        transition: all 0.15s ease;
    }

    a:hover {
        opacity: 0.85;
    }

    /* 图标动画 */
    .query-card-title i {
        transition: transform 0.15s ease;
    }

    .query-card:hover .query-card-title i {
        transform: scale(1.1);
    }

    /* 响应式 */
    @media (max-width: 1024px) {
        .query-sidebar {
            width: 220px;
        }

        .query-content-header h1 {
            font-size: 1.5rem;
        }
    }

    @media (max-width: 768px) {
        .query-page-container {
            flex-direction: column;
        }

        .query-sidebar {
            width: 100%;
            height: auto;
            position: relative;
            border-right: none;
            border-bottom: 1px solid #E5E7EB;
        }

        .query-content-header {
            padding: 1.5rem 1rem 1rem;
        }

        .query-content-header h1 {
            font-size: 1.25rem;
        }

        .query-content-body {
            padding: 0 1rem 1rem;
        }

        .query-card-body {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="query-page-container">
    <!-- 侧边栏 -->
    <aside class="query-sidebar">
        <div class="query-sidebar-header">
            <h2 class="query-sidebar-title">
                <i class="fas fa-history" style="color: #3B82F6;"></i>
                查询历史
            </h2>
        </div>

        <!-- 最近的查询 -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">最近查询</div>
            {% for query in recent_queries %}
            <div class="sidebar-query-item" onclick="loadQuery('{{ query.query_text|escapejs }}')">
                <div class="sidebar-query-time">{{ query.executed_at|timesince }}前</div>
                <div class="sidebar-query-text">{{ query.query_text|truncatechars:45 }}</div>
            </div>
            {% empty %}
            <p style="font-size: 0.875rem; color: #9CA3AF; padding: 0.5rem; text-align: center;">
                暂无查询记录
            </p>
            {% endfor %}
        </div>

        <!-- 保存的查询 -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">已保存查询</div>
            {% for query in saved_queries %}
            <div class="sidebar-query-item" onclick="loadQuery('{{ query.query_text|escapejs }}')">
                <div style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">
                    {{ query.name }}
                </div>
                <div class="sidebar-query-text">{{ query.query_text|truncatechars:40 }}</div>
            </div>
            {% empty %}
            <p style="font-size: 0.875rem; color: #9CA3AF; padding: 0.5rem; text-align: center;">
                暂无保存的查询
            </p>
            {% endfor %}
        </div>

        <!-- 快速链接 -->
        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #E5E7EB;">
            <a href="{% url 'query:saved_queries' %}"
               class="slds-button slds-button_outline-brand slds-button_small"
               style="width: 100%; justify-content: center;">
                <i class="fas fa-folder-open"></i>
                管理所有查询
            </a>
        </div>
    </aside>

    <!-- 主内容 -->
    <main class="query-main-content">
        <div class="query-content-header">
            <h1>SOQL 查询编辑器</h1>
        </div>

        <div class="query-content-body">
            <div class="slds-scope">
                <!-- 查询构建器 -->
                <div class="query-card">
                    <div class="query-card-header">
                        <h3 class="query-card-title">
                            <i class="fas fa-tools" style="color: #3B82F6;"></i>
                            查询构建器
                        </h3>
                    </div>
                    <div class="query-card-body">
                        <div class="slds-grid slds-gutters">
                            <!-- 对象选择器 -->
                            <div class="slds-col slds-size_1-of-3">
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label" for="object-selector">选择对象:</label>
                                    <div class="slds-form-element__control">
                                        <div class="slds-select_container">
                                            <select id="object-selector" class="slds-select"
                                                    data-has-initial="{{ has_initial_objects|yesno:'true,false' }}"
                                                    onchange="handleObjectSelection(this.value)">
                                                <option value="">-- 选择对象 --</option>
                                                {% if available_objects.standard %}
                                                <optgroup label="标准对象">
                                                    {% for obj in available_objects.standard %}
                                                    <option value="{{ obj.name }}">{{ obj.label }} ({{ obj.name }})</option>
                                                    {% endfor %}
                                                </optgroup>
                                                {% endif %}
                                                {% if available_objects.custom %}
                                                <optgroup label="自定义对象">
                                                    {% for obj in available_objects.custom %}
                                                    <option value="{{ obj.name }}">{{ obj.label }} ({{ obj.name }})</option>
                                                    {% endfor %}
                                                </optgroup>
                                                {% endif %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 快速操作 -->
                            <div class="slds-col slds-size_2-of-3">
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">快速操作:</label>
                                    <div class="slds-form-element__control">
                                        <div class="slds-button-group">
                                            <button type="button" class="slds-button slds-button_outline-brand"
                                                    onclick="selectAllFields()">
                                                <i class="fas fa-check"></i>
                                                选择全部字段
                                            </button>
                                            <button type="button" class="slds-button slds-button_outline-danger"
                                                    onclick="clearFieldSelection()">
                                                <i class="fas fa-times"></i>
                                                清除选择
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 字段和操作符 -->
                        <div class="slds-grid slds-gutters slds-m-top_medium hidden" id="query-builder-details">
                            <!-- 字段列表 -->
                            <div class="slds-col slds-size_1-of-2">
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">可用字段:</label>
                                    <div class="slds-form-element__control">
                                        <div class="field-list" id="field-list">
                                            <div style="color: #9CA3AF;">请先选择对象以显示字段</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 操作符和帮助器 -->
                            <div class="slds-col slds-size_1-of-2">
                                <div class="query-builder-section">
                                    <div class="slds-form-element">
                                        <label class="slds-form-element__label">运算符:</label>
                                        <div class="slds-form-element__control">
                                            <div class="slds-button-group-row">
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertOperator('AND')">AND</button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertOperator('OR')">OR</button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertOperator('NOT')">NOT</button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertOperator('IN')">IN</button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertOperator('LIKE')">LIKE</button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertOperator('=')">  =  </button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertOperator('!=')"> != </button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertOperator('<')"> &lt; </button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertOperator('>')"> &gt; </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="query-builder-section">
                                    <div class="slds-form-element">
                                        <label class="slds-form-element__label">子句:</label>
                                        <div class="slds-form-element__control">
                                            <div class="slds-button-group-row">
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertClause('WHERE')">WHERE</button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertClause('ORDER BY')">ORDER BY</button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertClause('GROUP BY')">GROUP BY</button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertClause('LIMIT')">LIMIT</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="query-builder-section">
                                    <div class="slds-form-element">
                                        <label class="slds-form-element__label">函数:</label>
                                        <div class="slds-form-element__control">
                                            <div class="slds-button-group-row">
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertFunction('COUNT()')">COUNT()</button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertFunction('SUM()')">SUM()</button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertFunction('AVG()')">AVG()</button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertFunction('MIN()')">MIN()</button>
                                                <button type="button" class="slds-button slds-button_brand slds-button_small operator-btn"
                                                        onclick="insertFunction('MAX()')">MAX()</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 查询表单 -->
                <div class="query-card">
                    <div class="query-card-header">
                        <h3 class="query-card-title">
                            <i class="fas fa-code" style="color: #3B82F6;"></i>
                            SOQL 查询
                        </h3>
                    </div>
                    <div class="query-card-body">
                        <form method="post" id="query-form" onsubmit="executeQueryAjax(event); return false;">
                            {% csrf_token %}

                            <!-- 查询输入 -->
                            <div class="slds-form-element slds-m-bottom_medium">
                                <label class="slds-form-element__label" for="{{ form.query.id_for_label }}">
                                    SOQL 查询语句:
                                </label>
                                <div class="slds-form-element__control">
                                    {{ form.query }}
                                    {% if form.query.errors %}
                                    <div class="slds-form-element__help" style="color: #DC2626;">
                                        {{ form.query.errors.0 }}
                                    </div>
                                    {% endif %}
                                    <div class="slds-form-element__help" style="color: #6B7280;">
                                        {{ form.query.help_text }}
                                    </div>
                                </div>
                            </div>

                            <!-- 选项 -->
                            <div class="slds-grid slds-gutters slds-m-bottom_medium">
                                <div class="slds-col slds-size_1-of-2">
                                    <div class="slds-form-element">
                                        <div class="slds-form-element__control">
                                            <div class="slds-checkbox">
                                                {{ form.include_deleted }}
                                                <label class="slds-checkbox__label" for="{{ form.include_deleted.id_for_label }}">
                                                    <span class="slds-checkbox_faux"></span>
                                                    <span class="slds-form-element__label">{{ form.include_deleted.label }}</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="slds-col slds-size_1-of-2">
                                    <button type="button" class="slds-button slds-button_outline-brand slds-button_small"
                                            onclick="validateQuery()">
                                        <i class="fas fa-check-circle"></i>
                                        验证查询
                                    </button>
                                </div>
                            </div>

                            <!-- 提交按钮 -->
                            <div class="slds-button-group">
                                <button type="submit" class="slds-button slds-button_brand">
                                    <i class="fas fa-play"></i>
                                    执行查询
                                </button>
                                <button type="button" class="slds-button slds-button_neutral" onclick="clearQuery()">
                                    <i class="fas fa-eraser"></i>
                                    清空
                                </button>
                                <button type="button" class="slds-button slds-button_success" onclick="saveQuery()"
                                        {% if not query_executed %}disabled{% endif %}>
                                    <i class="fas fa-save"></i>
                                    保存查询
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 查询结果 -->
                <div id="results-section">
                    {% if query_executed and results %}
                    <div class="query-card">
                        <div class="query-card-header">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <h3 class="query-card-title">
                                    <i class="fas fa-table" style="color: #3B82F6;"></i>
                                    查询结果
                                </h3>
                                <div class="slds-button-group">
                                    <a href="{% url 'query:export' results.history_id %}?format=csv"
                                       class="slds-button slds-button_outline-brand slds-button_small">
                                        <i class="fas fa-download"></i> CSV
                                    </a>
                                    <a href="{% url 'query:export' results.history_id %}?format=json"
                                       class="slds-button slds-button_outline-brand slds-button_small">
                                        <i class="fas fa-download"></i> JSON
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="query-card-body">
                            <!-- 结果信息 -->
                            <div class="slds-grid slds-gutters slds-m-bottom_medium">
                                <div class="slds-col slds-size_1-of-4">
                                    <div style="font-size: 0.875rem; color: #6B7280;">
                                        <strong style="color: #111827;">总记录数:</strong> {{ results.totalSize|default:0 }}
                                    </div>
                                </div>
                                <div class="slds-col slds-size_1-of-4">
                                    <div style="font-size: 0.875rem; color: #6B7280;">
                                        <strong style="color: #111827;">执行时间:</strong> {{ results.execution_time|floatformat:3 }}秒
                                    </div>
                                </div>
                                <div class="slds-col slds-size_1-of-4">
                                    <div style="font-size: 0.875rem; color: #6B7280;">
                                        <strong style="color: #111827;">显示记录:</strong> {{ results.records|length }}
                                    </div>
                                </div>
                                <div class="slds-col slds-size_1-of-4">
                                    {% if not results.done %}
                                    <span class="slds-badge slds-badge_warning">还有更多记录</span>
                                    {% else %}
                                    <span class="slds-badge slds-badge_success">已获取全部</span>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- 结果表格 -->
                            {% if results.records %}
                            <div class="query-results" style="overflow-x: auto;">
                                <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                                    <thead>
                                        <tr>
                                            {% for key in results.records.0.keys %}
                                            {% if key != 'attributes' %}
                                            <th scope="col">
                                                <div class="slds-truncate" title="{{ key }}">{{ key }}</div>
                                            </th>
                                            {% endif %}
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody id="results-tbody">
                                        {% for record in results.records %}
                                        <tr>
                                            {% for key, value in record.items %}
                                            {% if key != 'attributes' %}
                                            <td data-label="{{ key }}">
                                                <div class="slds-truncate">
                                                    {% if key|upper == 'ID' and value and results.object_type %}
                                                    <a href="{% url 'query:record_detail' results.object_type value %}"
                                                       style="color: #3B82F6; text-decoration: underline;">
                                                        {{ value }}
                                                    </a>
                                                    {% elif value == None %}
                                                    <span style="color: #9CA3AF;">null</span>
                                                    {% elif value|length > 100 %}
                                                    <span title="{{ value }}">{{ value|truncatechars:100 }}</span>
                                                    {% else %}
                                                    {{ value }}
                                                    {% endif %}
                                                </div>
                                            </td>
                                            {% endif %}
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- 加载更多按钮 -->
                            {% if not results.done and results.nextRecordsUrl %}
                            <div style="text-align: center; margin-top: 1.5rem;">
                                <button class="slds-button slds-button_outline-brand load-more-results"
                                        data-next-url="{{ results.nextRecordsUrl }}">
                                    <i class="fas fa-arrow-down"></i>
                                    加载更多
                                </button>
                            </div>
                            {% endif %}

                            {% else %}
                            <div style="text-align: center; padding: 3rem; color: #9CA3AF;">
                                <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p style="font-size: 1.125rem; font-weight: 500; color: #6B7280;">未找到任何记录</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局变量
let currentObject = null;
let currentFields = [];
let selectedFields = new Set();

// Phoenix 风格自定义 Select 初始化
function initCustomSelect(selectElement) {
    const $select = $(selectElement);
    if ($select.parent().hasClass('custom-select-wrapper')) {
        return; // 已经初始化过了
    }

    // 包装原生 select
    $select.wrap('<div class="custom-select-wrapper"></div>');
    const $wrapper = $select.parent();

    // 创建自定义 UI 元素
    const placeholder = $select.find('option[value=""]').text() || '请选择';
    const selectedOption = $select.find('option:selected');
    const selectedText = selectedOption.val() ? selectedOption.text() : placeholder;

    const customHTML = `
        <div class="custom-select-trigger">
            <span class="custom-select-trigger-text ${selectedOption.val() ? 'has-value' : ''}">${selectedText}</span>
            <span class="custom-select-arrow">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                    <path d="M4.427 5.927l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 5.5H4.604a.25.25 0 00-.177.427z"/>
                </svg>
            </span>
        </div>
        <div class="custom-select-dropdown"></div>
    `;

    $wrapper.append(customHTML);

    // 构建下拉选项
    buildCustomOptions($select, $wrapper);

    // 绑定事件
    bindCustomSelectEvents($wrapper, $select);
}

function buildCustomOptions($select, $wrapper) {
    const $dropdown = $wrapper.find('.custom-select-dropdown');
    $dropdown.empty();

    const selectedValue = $select.val();

    $select.children().each(function() {
        if ($(this).is('optgroup')) {
            // 处理 optgroup
            const label = $(this).attr('label');
            $dropdown.append(`<div class="custom-select-optgroup-label">${label}</div>`);

            $(this).children('option').each(function() {
                const value = $(this).val();
                const text = $(this).text();
                const isSelected = value === selectedValue;

                if (value) {
                    $dropdown.append(`
                        <div class="custom-select-option ${isSelected ? 'selected' : ''}" data-value="${value}">
                            ${text}
                        </div>
                    `);
                }
            });
        } else if ($(this).is('option')) {
            // 处理独立 option
            const value = $(this).val();
            const text = $(this).text();
            const isSelected = value === selectedValue;

            if (value) {
                $dropdown.append(`
                    <div class="custom-select-option ${isSelected ? 'selected' : ''}" data-value="${value}">
                        ${text}
                    </div>
                `);
            } else {
                // 占位符选项
                $dropdown.append(`
                    <div class="custom-select-option placeholder" data-value="">
                        ${text}
                    </div>
                `);
            }
        }
    });
}

function bindCustomSelectEvents($wrapper, $select) {
    const $trigger = $wrapper.find('.custom-select-trigger');
    const $dropdown = $wrapper.find('.custom-select-dropdown');

    // 点击触发器切换下拉菜单
    $trigger.on('click', function(e) {
        e.stopPropagation();

        // 关闭其他打开的下拉菜单
        $('.custom-select-trigger.active').not($trigger).each(function() {
            $(this).removeClass('active');
            $(this).siblings('.custom-select-dropdown').removeClass('active');
        });

        // 切换当前下拉菜单
        $trigger.toggleClass('active');
        $dropdown.toggleClass('active');
    });

    // 点击选项
    $dropdown.on('click', '.custom-select-option', function(e) {
        e.stopPropagation();

        if ($(this).hasClass('placeholder')) {
            return;
        }

        const value = $(this).data('value');
        const text = $(this).text().trim();

        // 更新原生 select
        $select.val(value).trigger('change');

        // 更新自定义 UI
        const $triggerText = $trigger.find('.custom-select-trigger-text');
        $triggerText.text(text).addClass('has-value');

        // 更新选中状态
        $dropdown.find('.custom-select-option').removeClass('selected');
        $(this).addClass('selected');

        // 关闭下拉菜单
        $trigger.removeClass('active');
        $dropdown.removeClass('active');
    });

    // 点击外部关闭下拉菜单
    $(document).on('click', function(e) {
        if (!$wrapper.is(e.target) && $wrapper.has(e.target).length === 0) {
            $trigger.removeClass('active');
            $dropdown.removeClass('active');
        }
    });

    // 键盘导航支持
    $trigger.on('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            $trigger.click();
        } else if (e.key === 'Escape') {
            $trigger.removeClass('active');
            $dropdown.removeClass('active');
        }
    });

    // 使触发器可聚焦
    $trigger.attr('tabindex', '0');
}

// 更新自定义 select（当选项改变时）
function updateCustomSelect($select) {
    const $wrapper = $select.closest('.custom-select-wrapper');
    if ($wrapper.length === 0) return;

    buildCustomOptions($select, $wrapper);

    // 更新触发器文本
    const selectedOption = $select.find('option:selected');
    const placeholder = $select.find('option[value=""]').text() || '请选择';
    const selectedText = selectedOption.val() ? selectedOption.text() : placeholder;

    const $triggerText = $wrapper.find('.custom-select-trigger-text');
    $triggerText.text(selectedText);

    if (selectedOption.val()) {
        $triggerText.addClass('has-value');
    } else {
        $triggerText.removeClass('has-value');
    }
}

// 页面加载时初始化
$(document).ready(function() {
    // 初始化对象选择器的自定义下拉菜单
    const selector = $('#object-selector');
    initCustomSelect(selector[0]);

    const hasInitialObjects = selector.data('has-initial') === true || selector.data('has-initial') === 'true';

    if (hasInitialObjects) {
        console.log('使用服务器渲染的 Salesforce 对象列表');
        restoreLastSelectedObject();
    } else {
        console.log('页面已加载，正在尝试加载 Salesforce 对象...');
        loadObjects();
    }
});

// 处理对象选择
window.handleObjectSelection = function(objectName) {
    if (objectName) {
        currentObject = objectName;
        selectedFields = new Set(['Id']);
        localStorage.setItem('lastSelectedObject', objectName);
        loadObjectFields(objectName);
        $('#id_query').val(`SELECT Id FROM ${objectName}`);
    } else {
        localStorage.removeItem('lastSelectedObject');
        $('#query-builder-details').addClass('hidden');
        currentObject = null;
        currentFields = [];
        selectedFields.clear();
        $('#id_query').val('');
    }
}

function restoreLastSelectedObject() {
    const lastSelectedObject = localStorage.getItem('lastSelectedObject');
    if (!lastSelectedObject) return;

    const selector = $('#object-selector');
    const optionExists = selector.find(`option[value="${lastSelectedObject}"]`).length > 0;
    if (optionExists) {
        selector.val(lastSelectedObject);
        updateCustomSelect(selector);
        handleObjectSelection(lastSelectedObject);
    }
}

// 加载所有 Salesforce 对象
function loadObjects() {
    $.ajax({
        url: '/query/api/objects/',
        method: 'GET',
        xhrFields: { withCredentials: true },
        credentials: 'same-origin'
    })
    .done(function(response) {
        if (response.success) {
            const selector = $('#object-selector');
            selector.empty();
            selector.append('<option value="">-- 选择对象 --</option>');

            if (!response.objects || response.objects.length === 0) {
                workbench.showToast('没有可用的 Salesforce 对象，请检查连接', 'warning');
                updateCustomSelect(selector);
                return;
            }

            const standardObjects = response.objects.filter(obj => !obj.custom);
            const customObjects = response.objects.filter(obj => obj.custom);

            if (standardObjects.length > 0) {
                const standardGroup = $('<optgroup label="标准对象"></optgroup>');
                standardObjects.forEach(obj => {
                    standardGroup.append(`<option value="${obj.name}">${obj.label} (${obj.name})</option>`);
                });
                selector.append(standardGroup);
            }

            if (customObjects.length > 0) {
                const customGroup = $('<optgroup label="自定义对象"></optgroup>');
                customObjects.forEach(obj => {
                    customGroup.append(`<option value="${obj.name}">${obj.label} (${obj.name})</option>`);
                });
                selector.append(customGroup);
            }

            // 更新自定义下拉菜单
            updateCustomSelect(selector);

            restoreLastSelectedObject();
        } else {
            workbench.showToast('对象加载失败: ' + response.error, 'error');
        }
    })
    .fail(function(xhr) {
        let errorMessage = 'Salesforce 对象加载失败';
        if (xhr.status === 401) {
            errorMessage = '未认证，请登录到 Salesforce';
            setTimeout(() => window.location.href = '/auth/login/', 3000);
        }
        workbench.showToast(errorMessage, 'error');
    });
}

// 加载选定对象的字段
function loadObjectFields(objectName) {
    $.ajax({
        url: '/query/api/fields/',
        method: 'GET',
        data: { object: objectName },
        xhrFields: { withCredentials: true },
        credentials: 'same-origin'
    })
    .done(function(response) {
        if (response.success) {
            currentObject = objectName;
            currentFields = response.fields;
            selectedFields = new Set(['Id']);

            displayFields(response.fields);
            $('#field-Id').prop('checked', true);
            $('#query-builder-details').removeClass('hidden');
            applyFieldsToQuery(orderSelectedFields());
        } else {
            workbench.showToast('字段加载失败: ' + response.error, 'error');
        }
    })
    .fail(function() {
        workbench.showToast('对象字段加载失败', 'error');
    });
}

// 在字段列表中显示字段
function displayFields(fields) {
    const fieldList = $('#field-list');
    fieldList.empty();

    const standardFields = fields.filter(f => !f.custom);
    const customFields = fields.filter(f => f.custom);

    // 添加搜索框
    fieldList.append(`
        <div style="margin-bottom: 0.75rem;">
            <input type="text" class="slds-input" id="field-search"
                   placeholder="搜索字段..." onkeyup="filterFields()" style="font-size: 0.875rem;">
        </div>
    `);

    const fieldContainer = $('<div id="field-items"></div>');

    if (standardFields.length > 0) {
        fieldContainer.append('<div style="font-size: 0.6875rem; font-weight: 600; color: #9CA3AF; text-transform: uppercase; margin: 0.5rem 0;">标准字段</div>');
        standardFields.forEach(field => fieldContainer.append(createFieldItem(field)));
    }

    if (customFields.length > 0) {
        fieldContainer.append('<div style="font-size: 0.6875rem; font-weight: 600; color: #9CA3AF; text-transform: uppercase; margin: 1rem 0 0.5rem;">自定义字段</div>');
        customFields.forEach(field => fieldContainer.append(createFieldItem(field)));
    }

    fieldList.append(fieldContainer);
}

// 创建字段项 HTML
function createFieldItem(field) {
    const checked = selectedFields.has(field.name) ? 'checked' : '';
    return `
        <div class="field-item" data-field-name="${field.name}">
            <input type="checkbox" class="field-checkbox" id="field-${field.name}"
                   value="${field.name}" ${checked}
                   onchange="toggleFieldAndUpdateQuery(this, '${field.name}')">
            <label for="field-${field.name}" style="cursor: pointer; flex: 1; margin: 0;">
                ${field.label}
                <span class="field-type">(${field.type})</span>
            </label>
        </div>
    `;
}

// 根据搜索过滤字段
function filterFields() {
    const searchTerm = $('#field-search').val().toLowerCase();
    $('.field-item').each(function() {
        const fieldName = $(this).data('field-name').toLowerCase();
        const fieldText = $(this).text().toLowerCase();
        $(this).toggle(fieldName.includes(searchTerm) || fieldText.includes(searchTerm));
    });
}

// 切换字段选择并更新查询
function toggleFieldAndUpdateQuery(checkbox, fieldName) {
    if (checkbox.checked) {
        selectedFields.add(fieldName);
    } else {
        selectedFields.delete(fieldName);
    }

    if (!currentObject) return;

    const fieldArray = orderSelectedFields();
    if (fieldArray.length === 0) {
        $('#id_query').val('');
        return;
    }

    applyFieldsToQuery(fieldArray);
}

// 清除字段选择
function clearFieldSelection() {
    selectedFields.clear();
    selectedFields.add('Id');
    $('.field-checkbox').prop('checked', false);
    $('.field-checkbox[value="Id"]').prop('checked', true);
    if (currentObject) {
        applyFieldsToQuery(orderSelectedFields());
        workbench.showToast('已清除字段选择', 'info');
    }
}

function orderSelectedFields() {
    let fieldArray = Array.from(selectedFields);
    if (fieldArray.includes('Id')) {
        fieldArray = fieldArray.filter(f => f !== 'Id');
        fieldArray.unshift('Id');
    }
    return fieldArray;
}

function applyFieldsToQuery(fieldArray) {
    if (!currentObject || fieldArray.length === 0) return;

    const fields = fieldArray.join(', ');
    let query = $('#id_query').val().trim();
    const fromClause = `FROM ${currentObject}`;
    const upperQuery = query.toUpperCase();
    const expectedFrom = fromClause.toUpperCase();

    if (!query || !/select\s+/i.test(query) || !upperQuery.includes(expectedFrom)) {
        query = `SELECT ${fields} ${fromClause}`;
    } else {
        query = query.replace(/SELECT\s+([\s\S]*?)\s+FROM/i, `SELECT ${fields} FROM`);
    }

    $('#id_query').val(query.trim());
}

// 将运算符插入查询
function insertOperator(operator) {
    const queryTextarea = $('#id_query')[0];
    const start = queryTextarea.selectionStart;
    const end = queryTextarea.selectionEnd;
    const text = queryTextarea.value;

    const insertion = ` ${operator} `;
    queryTextarea.value = text.substring(0, start) + insertion + text.substring(end);
    queryTextarea.selectionStart = queryTextarea.selectionEnd = start + insertion.length;
    queryTextarea.focus();
}

// 将子句插入查询
function insertClause(clause) {
    const queryTextarea = $('#id_query')[0];
    const text = queryTextarea.value;

    const clauses = {
        'WHERE': '\nWHERE ',
        'ORDER BY': '\nORDER BY ',
        'GROUP BY': '\nGROUP BY ',
        'LIMIT': '\nLIMIT 100',
        'OFFSET': '\nOFFSET 0'
    };

    const insertion = clauses[clause] || '';
    queryTextarea.value = text + insertion;
    queryTextarea.selectionStart = queryTextarea.selectionEnd = queryTextarea.value.length;
    queryTextarea.focus();
}

// 将函数插入查询
function insertFunction(func) {
    const queryTextarea = $('#id_query')[0];
    const start = queryTextarea.selectionStart;
    const end = queryTextarea.selectionEnd;
    const text = queryTextarea.value;

    queryTextarea.value = text.substring(0, start) + func + text.substring(end);
    queryTextarea.selectionStart = queryTextarea.selectionEnd = start + func.length - 1;
    queryTextarea.focus();
}

// 原始函数
function loadQuery(queryText) {
    $('#id_query').val(queryText);
}

function clearQuery() {
    $('#id_query').val('');
    $('#id_include_deleted').prop('checked', false);
}

function validateQuery() {
    const query = $('#id_query').val();
    const validation = workbench.validateSOQL(query);

    if (validation.isValid) {
        workbench.showToast('查询语法有效', 'success');
    } else {
        workbench.showToast('查询验证失败: ' + validation.errors.join(', '), 'error');
    }
}

function saveQuery() {
    const query = $('#id_query').val();
    if (!query.trim()) {
        workbench.showToast('没有可保存的查询', 'warning');
        return;
    }

    const name = prompt('输入此查询的名称:');
    if (!name) return;

    workbench.showToast('查询保存功能将在未来通过 AJAX 实现', 'info');
}

// 处理加载更多结果
$(document).on('click', '.load-more-results', function() {
    const button = $(this);
    const nextUrl = button.data('next-url');

    button.html('<i class="fas fa-spinner fa-spin"></i> 加载中...');

    $.get('/query/more/', { nextRecordsUrl: nextUrl })
        .done(function(response) {
            if (response.success) {
                const tbody = $('#results-tbody');
                const objectType = response.object_type;
                response.records.forEach(function(record) {
                    let row = '<tr>';
                    for (const [key, value] of Object.entries(record)) {
                        if (key === 'attributes') continue;

                        let displayValue;
                        if (key.toUpperCase() === 'ID' && value && objectType) {
                            displayValue = `<a href="/query/record/${objectType}/${value}/" style="color: #3B82F6; text-decoration: underline;">${value}</a>`;
                        } else if (value === null) {
                            displayValue = '<span style="color: #9CA3AF;">null</span>';
                        } else if (String(value).length > 100) {
                            displayValue = `<span title="${value}">${String(value).substring(0, 100)}...</span>`;
                        } else {
                            displayValue = value;
                        }
                        row += `<td><div class="slds-truncate">${displayValue}</div></td>`;
                    }
                    row += '</tr>';
                    tbody.append(row);
                });

                if (response.done || !response.nextRecordsUrl) {
                    button.hide();
                } else {
                    button.data('next-url', response.nextRecordsUrl);
                    button.html('<i class="fas fa-arrow-down"></i> 加载更多');
                }
            } else {
                workbench.showToast('加载额外结果失败: ' + response.error, 'error');
                button.html('<i class="fas fa-arrow-down"></i> 加载更多');
            }
        })
        .fail(function() {
            workbench.showToast('加载额外结果失败', 'error');
            button.html('<i class="fas fa-arrow-down"></i> 加载更多');
        });
});

// 通过 Ajax 执行查询
function executeQueryAjax(event) {
    event.preventDefault();

    const formData = new FormData(document.getElementById('query-form'));
    const queryText = $('#id_query').val();

    if (!queryText.trim()) {
        workbench.showToast('请输入查询', 'warning');
        return;
    }

    const selectedObject = $('#object-selector').val();

    $('#results-section').html('<div style="text-align: center; padding: 3rem;"><i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #3B82F6;"></i><p style="margin-top: 1rem; color: #6B7280;">加载中...</p></div>');

    $.ajax({
        url: '/query/',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            const newContent = $(response).find('#results-section').html();
            if (newContent) {
                $('#results-section').html(newContent);

                if (selectedObject) {
                    $('#object-selector').val(selectedObject);
                    localStorage.setItem('lastSelectedObject', selectedObject);
                }

                workbench.showToast('查询执行成功', 'success');
            } else {
                $('#results-section').html('<div style="padding: 2rem; text-align: center; color: #DC2626;">未返回查询结果</div>');
            }
        },
        error: function(xhr, status, error) {
            $('#results-section').html('<div style="padding: 2rem; text-align: center; color: #DC2626;">查询执行错误: ' + error + '</div>');
            workbench.showToast('查询执行失败', 'error');
        }
    });
}

// 选择所有字段
function selectAllFields() {
    if (!currentFields) {
        workbench.showToast('请先选择一个对象', 'warning');
        return;
    }

    $('#field-items .field-checkbox').prop('checked', true);
    selectedFields = new Set(currentFields.map(field => field.name));
    if (!selectedFields.has('Id')) {
        selectedFields.add('Id');
    }

    const fieldArray = orderSelectedFields();
    applyFieldsToQuery(fieldArray);
    workbench.showToast('已选择所有字段', 'success');
}
</script>
{% endblock %}
