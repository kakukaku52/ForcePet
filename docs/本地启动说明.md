# 本地启动说明

本文档指引你在本地机器上启动 Django Workbench（Salesforce Web App）。按照步骤完成后，可通过浏览器访问 http://localhost:8000 体验全部已实现的功能。

---

## 1. 环境准备

- **操作系统**：macOS / Linux / Windows 10+
- **Python**：3.11 及以上版本
- **pip / venv**：建议使用 `python -m venv` 创建隔离环境
- **数据库**：开发环境可直接使用仓库随附的 `db.sqlite3`；若想切换 PostgreSQL，请自行配置连接信息
- **Redis（可选）**：运行 Celery 异步任务和定时任务时需要
- **Salesforce Connected App**：准备好 `Consumer Key`、`Consumer Secret`、回调地址等信息，以完成 OAuth 登录
- **Node / 前端工具（可选）**：如果你要进一步定制前端资源

> 📌 如果选择 Docker 方式，可跳过本节大部分手工依赖配置，直接运行容器。

---

## 2. 克隆与虚拟环境

```bash
# 获取代码
git clone <你的仓库地址>
cd ForcePet

# 创建虚拟环境
python3 -m venv .venv          # Windows 下为 python
source .venv/bin/activate      # Windows 为 .venv\Scripts\activate
```

> 若仓库中已有 `venv/` 目录，可直接复用；但推荐全新创建以避免路径不一致。

---

## 3. 安装依赖

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

- 如需开发工具（如 `black`、`pytest`），请在 `requirements-dev.txt`（若存在）中单独安装。

---

## 4. 配置环境变量

1. 复制示例配置或直接编辑 `.env`：
   ```bash
   cp .env .env.local  # 若想保留原文件，可另存为局部配置
   ```
2. 核对 / 设置以下关键变量：
   - `DJANGO_SECRET_KEY`：Django 用于加密的随机字符串
   - `DEBUG`：建议开发环境设置为 `True`
   - `ALLOWED_HOSTS`：本地开发可设为 `localhost,127.0.0.1`
   - `SALESFORCE_CONSUMER_KEY`、`SALESFORCE_CONSUMER_SECRET`、`SALESFORCE_REDIRECT_URI`
   - `DATABASE_URL`：如需切换 PostgreSQL / 其他数据库
   - `REDIS_URL`：启用 Celery 时使用

> 可以通过 `python -c "import secrets; print(secrets.token_urlsafe(50))"` 快速生成 `DJANGO_SECRET_KEY`。

---

## 5. 数据库迁移与初始数据

```bash
python manage.py migrate

# 如需 Django Admin 登录，可创建超级用户
python manage.py createsuperuser
```

- 本地默认使用 `db.sqlite3`；若改用 PostgreSQL，请确保数据库已创建且连接信息正确。

---

## 6. 启动开发服务器

```bash
python manage.py runserver 0.0.0.0:8000
```

- 浏览器访问：http://localhost:8000
- 管理后台：http://localhost:8000/admin
- 默认首页跳转到登录页面，支持 Salesforce OAuth 与用户名/密码方式。

---

## 7. Celery 与其他后台服务（可选）

若需执行后台任务（批量操作、定时任务）：

```bash
# 终端 1：启动 Celery Worker
celery -A workbench_project worker -l info

# 终端 2：启动 Celery Beat（定时任务）
celery -A workbench_project beat -l info
```

- 请确保 `.env` 中配置了有效的 `CELERY_BROKER_URL`（默认 Redis）。

---

## 8. Docker 启动方式（可选）

仓库提供了 `docker-compose.yml`，可快速拉起全部服务。

```bash
docker-compose up --build
```

- 默认会启动 Django 应用、Redis 等服务。
- 首次执行会自动安装依赖并应用迁移。
- 停止时使用 `docker-compose down`。

---

## 9. 常见问题排查

| 问题 | 排查步骤 |
| ---- | -------- |
| 登录失败 | 确认 Connected App 配置、回调地址、OAuth Scope，并检查 Salesforce API 是否启用 |
| OAuth 回调报错 | `SALESFORCE_REDIRECT_URI` 必须与 Connected App 完全一致；检查 HTTPS/HTTP |
| Celery 无法连接 | 核对 `CELERY_BROKER_URL` 指向的 Redis 是否已启动，账号密码是否正确 |
| 静态资源缺失 | 确保 `python manage.py collectstatic`（部署场景）或在 DEBUG 模式下由 Django 提供 |

---

## 10. 后续步骤

- 配置 Git hooks 或 CI，以自动运行测试和格式化工具。
- 若要部署到正式环境，建议改用 PostgreSQL/Redis，并关闭 `DEBUG`、配置 `ALLOWED_HOSTS`。
- 结合 README 中的“Troubleshooting”“Security considerations”章节，完善本地环境的安全设置。

如需进一步帮助，欢迎在文档或 issue 中补充问题。祝开发顺利！
