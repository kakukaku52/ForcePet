{% extends "base.html" %}
{% load static %}

{% block title %}ログイン - ForcePet Studio{% endblock %}

{% block extra_css %}
<link href="{% static 'css/forcepet-studio.css' %}" rel="stylesheet">
{% endblock %}

{% block layout %}
<div class="fp-auth-wrapper">
    <div class="fp-auth-card">

        <!-- Header -->
        <div class="fp-auth-header">
            <div class="fp-auth-logo">
                <i class="fas fa-cube"></i>
            </div>
            <div class="fp-auth-title">ForcePet Studio</div>
            <div class="fp-auth-subtitle">Salesforce 開発者向け統合環境</div>
        </div>

        <!-- Custom Tabs -->
        <div class="fp-auth-tabs">
            <div class="fp-auth-tab active" id="tab-oauth" onclick="switchTab('oauth')">
                <i class="fas fa-cloud"></i>OAuth ログイン
            </div>
            <div class="fp-auth-tab" id="tab-standard" onclick="switchTab('standard')">
                <i class="fas fa-key"></i>標準ログイン
            </div>
        </div>

        <!-- Alerts -->
        <div id="auth-error" class="fp-alert fp-alert-danger" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span id="auth-error-msg"></span>
        </div>

        <div id="auth-success" class="fp-alert fp-alert-success" style="display: none;">
            <i class="fas fa-check-circle"></i>
            <span id="auth-success-msg"></span>
        </div>

        <!-- OAuth Form -->
        <div id="form-oauth">
            {% if oauth_enabled %}
            <form method="post" action="{% url 'authentication:login' %}" id="oauth-login-form">
                {% csrf_token %}
                <input type="hidden" name="login_type" value="oauth">

                <div class="fp-form-group">
                    <label class="fp-form-label">
                        環境<span class="fp-form-label-hint">(Environment)</span>
                    </label>
                    <select name="environment" class="fp-select fp-input-lg" onchange="toggleCustomDomain(this.value)">
                        <option value="production">本番 (Production)</option>
                        <option value="sandbox">Sandbox</option>
                        <option value="custom">カスタムドメイン</option>
                    </select>
                </div>

                <div class="fp-form-group" id="oauth-custom-domain" style="display: none;">
                    <label class="fp-form-label">カスタムドメイン URL</label>
                    <input type="text" name="custom_domain" class="fp-input fp-input-lg" placeholder="https://my-domain.my.salesforce.com">
                </div>

                <div class="fp-form-group">
                    <label class="fp-form-label">
                        API バージョン<span class="fp-form-label-hint">(API Version)</span>
                    </label>
                    <input type="text" name="api_version" class="fp-input fp-input-lg" value="62.0" placeholder="62.0">
                </div>

                {{ oauth_form.state }}

                <button type="submit" class="fp-btn fp-btn-primary fp-btn-block">
                    <i class="fab fa-salesforce"></i>
                    Salesforce でログイン
                </button>
            </form>
            {% else %}
            <div class="fp-auth-info">
                <i class="fas fa-info-circle"></i>
                <span>OAuth login is not configured. Please use Standard Login or contact your administrator.</span>
            </div>
            {% endif %}
        </div>

        <!-- Standard Form (Hidden by default) -->
        <div id="form-standard" style="display: none;">
            <form method="post" action="{% url 'authentication:login' %}" id="standard-login-form">
                {% csrf_token %}
                <input type="hidden" name="login_type" value="standard">

                <div class="fp-form-group">
                    <label class="fp-form-label">
                        ユーザー名<span class="fp-form-label-hint">(Username)</span>
                    </label>
                    <input type="text" name="username" class="fp-input fp-input-lg" placeholder="user@example.com" required>
                </div>

                <div class="fp-form-group">
                    <label class="fp-form-label">
                        パスワード<span class="fp-form-label-hint">(Password)</span>
                    </label>
                    <input type="password" name="password" class="fp-input fp-input-lg" required>
                </div>

                <div class="fp-form-group">
                    <label class="fp-form-label">
                        セキュリティトークン<span class="fp-form-label-hint">(Security Token - Optional)</span>
                    </label>
                    <input type="text" name="security_token" class="fp-input fp-input-lg" placeholder="省略可能">
                </div>

                <div class="fp-form-group">
                    <label class="fp-form-label">
                        環境<span class="fp-form-label-hint">(Environment)</span>
                    </label>
                    <select name="environment" class="fp-select fp-input-lg" onchange="toggleStandardCustomDomain(this.value)">
                        <option value="production">本番 (Production)</option>
                        <option value="sandbox">Sandbox</option>
                        <option value="custom">カスタムドメイン</option>
                    </select>
                </div>

                <div class="fp-form-group" id="standard-custom-domain" style="display: none;">
                    <label class="fp-form-label">カスタムドメイン URL</label>
                    <input type="text" name="custom_domain" class="fp-input fp-input-lg" placeholder="https://my-domain.my.salesforce.com">
                </div>

                <div class="fp-form-group">
                    <label class="fp-form-label">
                        API バージョン<span class="fp-form-label-hint">(API Version)</span>
                    </label>
                    <input type="text" name="api_version" class="fp-input fp-input-lg" value="62.0">
                </div>

                <div class="fp-form-group">
                    <label class="fp-checkbox-label">
                        <input type="checkbox" name="remember_me">
                        ログイン情報を記憶する
                    </label>
                </div>

                <button type="submit" class="fp-btn fp-btn-primary fp-btn-block">
                    <i class="fas fa-sign-in-alt"></i>
                    ログイン
                </button>
            </form>
        </div>

        <!-- Footer -->
        <div class="fp-auth-footer">
            <i class="fas fa-shield-alt"></i>
            <span>Protected by ForcePet Security</span>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Tab Switching Logic
function switchTab(tabName) {
    // Update Tabs
    document.querySelectorAll('.fp-auth-tab').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');

    // Update Content
    document.getElementById('form-oauth').style.display = 'none';
    document.getElementById('form-standard').style.display = 'none';
    document.getElementById('form-' + tabName).style.display = 'block';

    // Clear alerts when switching
    document.getElementById('auth-error').style.display = 'none';
    document.getElementById('auth-success').style.display = 'none';
}

// Toggle Custom Domain Inputs
function toggleCustomDomain(val) {
    const el = document.getElementById('oauth-custom-domain');
    el.style.display = (val === 'custom') ? 'block' : 'none';
}

function toggleStandardCustomDomain(val) {
    const el = document.getElementById('standard-custom-domain');
    el.style.display = (val === 'custom') ? 'block' : 'none';
}

// AJAX for Standard Login
$(document).ready(function() {
    $('#standard-login-form').on('submit', function(e) {
        e.preventDefault();

        // Reset alerts
        $('#auth-error').hide();
        $('#auth-success').hide();

        const btn = $(this).find('button[type="submit"]');
        const originalHtml = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> サインイン中...');

        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            success: function(res) {
                if(res.success) {
                    $('#auth-success-msg').text(res.message);
                    $('#auth-success').show();
                    setTimeout(() => window.location.href = res.redirect_url, 500);
                }
            },
            error: function(xhr) {
                btn.prop('disabled', false).html(originalHtml);
                let msg = 'ログインに失敗しました';
                if(xhr.responseJSON && xhr.responseJSON.error && xhr.responseJSON.error.message) {
                    msg = xhr.responseJSON.error.message;
                }
                $('#auth-error-msg').text(msg);
                $('#auth-error').show();
            }
        });
    });
});
</script>
{% endblock %}
