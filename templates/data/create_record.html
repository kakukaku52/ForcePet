{% extends 'base.html' %}
{% load static %}

{% block title %}Data Loader - ForcePet Studio{% endblock %}

{% block extra_css %}
<link href="{% static 'css/forcepet-studio.css' %}" rel="stylesheet">
<style>
    /* Data Loader Specific Styles */
    .active-op {
        background-color: #e0f2fe;
        color: #0284c7;
        border-radius: 4px;
    }
    
    .step-container {
        display: none;
        height: 100%;
        flex-direction: column;
    }
    
    .step-container.active {
        display: flex;
    }
    
    .step-content {
        flex: 1;
        overflow: auto;
        padding: 20px;
    }
    
    /* Mapping Table */
    .mapping-row {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
        align-items: center;
    }
</style>
{% endblock %}

{% block sidebar %}
<div class="fp-sidebar-header">DATA LOADER</div>
<div class="fp-sidebar-content">
    
    <!-- Operation -->
    <div class="fp-section">
        <div class="fp-section-header" onclick="$(this).parent().toggleClass('collapsed')">
            <i class="fas fa-chevron-down"></i> OPERATION
        </div>
        <div class="fp-section-body">
            <div class="field-item {% if '/data/insert' in request.path %}active-op{% endif %}" onclick="location.href='{% url 'data:insert' %}'">
                <i class="fas fa-plus text-success" style="width: 20px;"></i> Insert
            </div>
            <div class="field-item {% if '/data/update' in request.path %}active-op{% endif %}" onclick="location.href='{% url 'data:update' %}'">
                <i class="fas fa-edit text-warning" style="width: 20px;"></i> Update
            </div>
            <div class="field-item {% if '/data/upsert' in request.path %}active-op{% endif %}" onclick="location.href='{% url 'data:upsert' %}'">
                <i class="fas fa-sync text-info" style="width: 20px;"></i> Upsert
            </div>
            <div class="field-item {% if '/data/delete' in request.path %}active-op{% endif %}" onclick="location.href='{% url 'data:delete' %}'">
                <i class="fas fa-trash text-danger" style="width: 20px;"></i> Delete
            </div>
            <div class="field-item {% if '/data/undelete' in request.path %}active-op{% endif %}" onclick="location.href='{% url 'data:undelete' %}'">
                <i class="fas fa-undo text-secondary" style="width: 20px;"></i> Undelete
            </div>
        </div>
    </div>

    <!-- Object Selection -->
    <div class="fp-section">
        <div class="fp-section-header" onclick="$(this).parent().toggleClass('collapsed')">
            <i class="fas fa-chevron-down"></i> TARGET
        </div>
        <div class="fp-section-body">
            <div style="margin-bottom: 10px;">
                <label class="fp-form-label" style="font-size: 10px; color: #94a3b8;">OBJECT</label>
                <!-- Native select for simplicity and robustness -->
                <select id="sobject-select" class="fp-select w-100">
                    <option value="">Select Object...</option>
                    <!-- Populated by JS -->
                </select>
            </div>
            
            <div>
                <label class="fp-form-label" style="font-size: 10px; color: #94a3b8;">MODE</label>
                <select id="mode-select" class="fp-select w-100" onchange="toggleMode(this.value)">
                    <option value="single">Single Record</option>
                    <option value="csv">CSV Upload</option>
                </select>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block content %}
<!-- Step 1: Configuration -->
<div id="step-config" class="step-container active">
    <!-- Toolbar -->
    <div class="fp-toolbar">
        <div class="d-flex align-items-center gap-2">
            <i class="fas fa-cog text-primary"></i>
            <div style="font-weight: 600;">Configuration</div>
        </div>
        <div style="flex: 1;"></div>
        <button class="fp-btn fp-btn-primary" onclick="goToNextStep()">Next <i class="fas fa-arrow-right ms-1"></i></button>
    </div>

    <!-- Content -->
    <div class="step-content">
        <!-- Single Record Config -->
        <div id="config-single">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="m-0">Fields</h6>
                <button class="fp-btn fp-btn-secondary" onclick="addSingleField()"><i class="fas fa-plus"></i> Add Field</button>
            </div>
            <table class="fp-table" id="single-fields-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Field</th>
                        <th>Value</th>
                        <th style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows -->
                </tbody>
            </table>
            <div class="text-center p-4 text-muted fst-italic" id="single-empty-msg">
                Add fields to start creating a record
            </div>
        </div>

        <!-- CSV Config -->
        <div id="config-csv" style="display: none;">
            <div class="mb-4" style="max-width: 600px;">
                <label class="fp-form-label">Upload CSV File</label>
                <input type="file" id="csv-file-input" accept=".csv" class="fp-input" style="height: auto; padding: 8px; width: 100%;">
                <div class="mt-2 text-muted" style="font-size: 11px;">File must contain a header row.</div>
            </div>
        </div>
    </div>
</div>

<!-- Step 2: Confirmation (CSV Mapping or Single Preview) -->
<div id="step-confirm" class="step-container">
    <div class="fp-toolbar">
        <button class="fp-btn fp-btn-secondary" onclick="goToConfigStep()"><i class="fas fa-arrow-left ms-1"></i> Back</button>
        <div class="ms-2" style="font-weight: 600;">Confirmation</div>
        <div style="flex: 1;"></div>
        <button class="fp-btn fp-btn-primary" id="execute-btn" onclick="executeOperation()">
            <i class="fas fa-play me-1"></i> 
            <span id="execute-label">Insert</span>
        </button>
    </div>
    
    <div class="step-content">
        <!-- Single Confirm -->
        <div id="confirm-single">
            <div class="alert fp-alert-success mb-3">
                <i class="fas fa-info-circle"></i> Ready to insert 1 record into <strong id="confirm-obj-name" class="ms-1"></strong>
            </div>
            <table class="fp-table">
                <thead><tr><th>Field</th><th>Value</th></tr></thead>
                <tbody id="confirm-single-tbody"></tbody>
            </table>
        </div>

        <!-- CSV Mapping & Preview -->
        <div id="confirm-csv" style="display: none;">
            <!-- Mapping -->
            <div class="mb-4">
                <h6 class="mb-2">Field Mapping</h6>
                <div class="p-3 bg-light border rounded" id="csv-mapping-container">
                    <!-- Mappings -->
                </div>
            </div>
            <!-- Preview -->
            <div>
                <h6 class="mb-2">Data Preview (Top 5)</h6>
                <div style="overflow-x: auto;">
                    <table class="fp-table" id="csv-preview-table">
                        <thead id="csv-preview-head"></thead>
                        <tbody id="csv-preview-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Step 3: Results -->
<div id="step-results" class="step-container">
    <div class="fp-toolbar">
        <button class="fp-btn fp-btn-secondary" onclick="location.reload()"><i class="fas fa-redo ms-1"></i> Start Over</button>
        <div class="ms-2" style="font-weight: 600;">Operation Results</div>
    </div>
    <div class="step-content">
        <div id="result-summary" class="mb-3"></div>
        <table class="fp-table" id="result-table">
            <thead>
                <tr><th>Status</th><th>ID</th><th>Errors</th></tr>
            </thead>
            <tbody id="result-tbody"></tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Pass data to JS -->
{{ sobjects|json_script:"sobject-data" }}

<script>
// Global State
const STATE = {
    sobjects: JSON.parse(document.getElementById('sobject-data').textContent),
    fields: [], // Loaded fields for current object
    currentObj: null,
    mode: 'single', // single | csv
    csvData: null, // Parsed CSV data
    csvHeaders: [],
    mappings: {}, // CSV Header -> SF Field
    singleData: [] // Array of {field, value}
};

// URLs
const URLS = {
    fields: "{{ fields_api_url }}",
    insert: "{{ insert_post_url }}" 
};

$(document).ready(function() {
    initSObjectSelect();
});

// --- Init ---
function initSObjectSelect() {
    const sel = $('#sobject-select');
    STATE.sobjects.forEach(obj => {
        sel.append(new Option(`${obj.label} (${obj.name})`, obj.name));
    });
    
    sel.on('change', function() {
        const val = $(this).val();
        if (val) loadFields(val);
        else STATE.fields = [];
        STATE.currentObj = val;
        $('#single-empty-msg').text(val ? 'Add fields to start' : 'Select an object first');
    });
}

function toggleMode(mode) {
    STATE.mode = mode;
    if (mode === 'single') {
        $('#config-single').show();
        $('#config-csv').hide();
    } else {
        $('#config-single').hide();
        $('#config-csv').show();
    }
}

function loadFields(objName) {
    // Show loading?
    $.get(URLS.fields, { object: objName }, function(res) {
        if (res.success) {
            STATE.fields = res.fields.sort((a,b) => a.label.localeCompare(b.label));
            // Clear current table if any
            $('#single-fields-table tbody').empty();
            $('#single-empty-msg').show();
        }
    });
}

// --- Single Record Logic ---
function addSingleField() {
    if (!STATE.currentObj) {
        alert('Please select an object first.');
        return;
    }
    $('#single-empty-msg').hide();
    
    const rowId = Date.now();
    const options = STATE.fields.map(f => `<option value="${f.name}">${f.label} (${f.name})</option>`).join('');
    
    const row = `
        <tr id="row-${rowId}">
            <td>
                <select class="fp-select w-100 field-select">
                    <option value="">Select Field...</option>
                    ${options}
                </select>
            </td>
            <td>
                <input type="text" class="fp-input w-100 field-value" placeholder="Value">
            </td>
            <td class="text-center">
                <button class="fp-btn fp-btn-icon text-danger" onclick="$('#row-${rowId}').remove()"><i class="fas fa-times"></i></button>
            </td>
        </tr>
    `;
    $('#single-fields-table tbody').append(row);
}

// --- Navigation ---
function goToNextStep() {
    if (!STATE.currentObj) {
        alert('Please select an object.');
        return;
    }

    if (STATE.mode === 'single') {
        // Validate Single
        STATE.singleData = [];
        let isValid = true;
        $('#single-fields-table tbody tr').each(function() {
            const field = $(this).find('.field-select').val();
            const val = $(this).find('.field-value').val();
            if (field && val) {
                STATE.singleData.push({ field, value: val });
            }
        });
        
        if (STATE.singleData.length === 0) {
            alert('Please add at least one field value.');
            return;
        }
        
        // Render Confirm
        $('#confirm-obj-name').text(STATE.currentObj);
        const tbody = $('#confirm-single-tbody');
        tbody.empty();
        STATE.singleData.forEach(d => {
            tbody.append(`<tr><td>${d.field}</td><td>${d.value}</td></tr>`);
        });
        
        $('#confirm-single').show();
        $('#confirm-csv').hide();
        
    } else {
        // Validate CSV
        const fileInput = document.getElementById('csv-file-input');
        if (!fileInput.files[0]) {
            alert('Please select a CSV file.');
            return;
        }
        
        // Parse CSV (Simple implementation)
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const rows = text.split('\n').map(r => r.split(',')); // Very basic CSV parser
            if (rows.length < 2) { alert('Empty CSV'); return; }
            
            STATE.csvHeaders = rows[0].map(h => h.trim());
            STATE.csvData = rows.slice(1).filter(r => r.length === STATE.csvHeaders.length); // Filter bad rows
            
            renderCsvPreview();
            renderCsvMapping();
            
            $('#confirm-single').hide();
            $('#confirm-csv').show();
            
            // Switch view
            showStep('step-confirm');
        };
        reader.readAsText(fileInput.files[0]);
        return; // Async wait
    }
    
    showStep('step-confirm');
}

function goToConfigStep() {
    showStep('step-config');
}

function showStep(stepId) {
    $('.step-container').removeClass('active');
    $('#' + stepId).addClass('active');
}

function renderCsvPreview() {
    const thead = $('#csv-preview-head');
    const tbody = $('#csv-preview-body');
    thead.empty();
    tbody.empty();
    
    let hRow = '<tr>';
    STATE.csvHeaders.forEach(h => hRow += `<th>${h}</th>`);
    hRow += '</tr>';
    thead.html(hRow);
    
    STATE.csvData.slice(0, 5).forEach(row => {
        let bRow = '<tr>';
        row.forEach(c => bRow += `<td>${c}</td>`);
        bRow += '</tr>';
        tbody.append(bRow);
    });
}

function renderCsvMapping() {
    const container = $('#csv-mapping-container');
    container.empty();
    
    STATE.csvHeaders.forEach((header, idx) => {
        // Auto-match
        const match = STATE.fields.find(f => f.name.toLowerCase() === header.toLowerCase() || f.label.toLowerCase() === header.toLowerCase());
        const selected = match ? match.name : '';
        
        const options = STATE.fields.map(f => `<option value="${f.name}" ${f.name === selected ? 'selected' : ''}>${f.label} (${f.name})</option>`).join('');
        
        const html = `
            <div class="mapping-row">
                <div style="width: 150px; font-weight:600;">${header}</div>
                <div style="color: #94a3b8;">&rarr;</div>
                <select class="fp-select mapping-select" data-csv-index="${idx}" style="flex:1;">
                    <option value="">(Skip)</option>
                    ${options}
                </select>
            </div>
        `;
        container.append(html);
    });
}

// --- Execute ---
function executeOperation() {
    const btn = $('#execute-btn');
    const originalText = btn.html();
    btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');
    
    let payload = {};
    
    if (STATE.mode === 'single') {
        const record = {};
        STATE.singleData.forEach(d => record[d.field] = d.value);
        payload = {
            sobject: STATE.currentObj,
            records: JSON.stringify([record]), // Array of 1
            mode: 'single'
        };
    } else {
        // Map CSV data
        const mappedRecords = [];
        const mappings = []; // Index -> FieldName
        
        $('.mapping-select').each(function() {
            const idx = $(this).data('csv-index');
            const field = $(this).val();
            if (field) mappings[idx] = field;
        });
        
        STATE.csvData.forEach(row => {
            const rec = {};
            row.forEach((val, idx) => {
                if (mappings[idx]) rec[mappings[idx]] = val;
            });
            mappedRecords.push(rec);
        });
        
        payload = {
            sobject: STATE.currentObj,
            records: JSON.stringify(mappedRecords),
            mode: 'bulk' // or csv
        };
    }
    
    // AJAX Post
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    payload.csrfmiddlewaretoken = csrf;
    
    $.post(URLS.insert, payload, function(res) {
        btn.prop('disabled', false).html(originalText);
        renderResults(res);
        showStep('step-results');
    }).fail(function(xhr) {
        btn.prop('disabled', false).html(originalText);
        alert('Error: ' + xhr.responseText);
    });
}

function renderResults(res) {
    const tbody = $('#result-tbody');
    tbody.empty();
    
    let successCount = 0;
    let failCount = 0;
    
    // Handle single or bulk response structure
    // Assuming response is list of results
    const results = res.results || (Array.isArray(res) ? res : [res]);
    
    results.forEach(r => {
        if (r.success) successCount++; else failCount++;
        const err = r.errors ? r.errors.map(e => e.message).join('; ') : '';
        
        tbody.append(`
            <tr>
                <td>${r.success ? '<span class="fp-badge bg-success text-white">Success</span>' : '<span class="fp-badge bg-danger text-white">Failed</span>'}</td>
                <td>${r.id || '-'}</td>
                <td class="text-danger">${err}</td>
            </tr>
        `);
    });
    
    $('#result-summary').html(
        `<span class="text-success fw-bold">${successCount} Success</span>, 
        <span class="text-danger fw-bold">${failCount} Failed</span>`
    );
}

</script>
{% endblock %}